比特币密码学原理
---

比特币虽然叫加密货币（crypto-currency），但比特币内容不加密，所有信息都是公开的。

比特币中主要用到了密码学中的两个知识，哈希（crypto-hash-function）和数字签名（digital signature）

## 一、哈希函数（crypto-hash-function）

密码学中使用的哈希函数叫做 crypto-hash-function，在比特币中主要应用了其两个性质，抗哈希碰撞（Collision resistance）和不可逆（hiding）

### 1.哈希碰撞对抗（Collision resistance）

1.1 什么是哈希碰撞？

假设输入 x != y, 通过哈希函数 H，得到的输出 H（x） = H（y）

1.2 哈希碰撞是不可避免的，因为输入空间远远大于输出空间

如果是256位哈希，最大输出空间只有2的256次方，而输入空间却是无限大的

1.3 没有什么高效的方法能人为的制造哈希碰撞

* 虽然哈希函数目前没有被数学证明一定没有方法能高效地制造碰撞，但从长期经验看，没有找到什么高效的方式能人为制造哈希碰撞。
* 目前只能通过暴力求解（brute-force）的方式试出碰撞，假如通过 H（x） 算出了256位哈希，想找到 x' 得到同样的哈希，需要不断地改输入去试，这个过程工作量巨大，几乎是不可能的。

### 2.不可逆（hiding）

2.1 什么是不可逆？

x -> H（x），x 通过 H 得到了 H（x），反过来 H（x） -> x 是行不通的

2.2 不可逆的性质有什么用？

在讲比特币/数字世界的应用前，我们先了解一个实际中的例子。

比如有人说可以预测第二天股市的某只股票会涨停，那么他要如何证明自己预测是准确的呢？

* 预测结果，不可以提前公开。
    *一种方法是他可以提前一天向大家公布哪一只股票会涨停，这么做的问题是预测结果提前公布后，会对真实的结果有影响，比如那个人是股神，本来股票不会涨停，大家听股神预测后纷纷买入，结果却涨停了。*


* 不提前公开，怎么证明预测结果没被篡改？
    *他可以提前将结果放在信封里密封起来，交给权威机构保管，等到第二天股市收盘出来后再打开信封让大家验证预测结果是否准确*

在电子数字世界中，也有类似的方式，叫做 digital equivalent of sealed envilope，我们可以先对预测结果做哈希运算，得到 H（预测结果），将结果先公布出去，由于哈希具有 hiding 和 collision resistance 的性质，大家无法事先逆推出预测结果，也很难对预测结果篡改（需要巨大工作量暴力解）。假如有人篡改了结果，一定是 H（篡改结果）!=  H（预测结果），于是就能提前公布结果，并且保证预测结果是安全唯一的。

2.3 不可逆的前提

* 输入范围足够大且分布比较均匀，如果输入范围很大，却集中在很小的一部分，还是很容易暴力破解。
* 所以我们经常需要增加随机数 nonce，来保证上述两点，即 H（x || nonce）


### 3.哈希值不可预测（puzzle friendly）

只根据输入，很难猜出来哈希值是什么，只能暴力地一个一个输入去试。

3.1 具体例子

比如给定一个256位哈希值，要求前k位都是0，让你找到一个输入能得到这样的结果。由于 puzzle friendly 性质，只能通过大量的尝试才能找到那个输入。

3.2 简单了解比特币中的「挖矿」

我们知道比特币是一个区块一个区块连接起来的，那是谁造的区块呢？又是怎么造的呢？简单来说，前区块指定一个哈希值 target，看谁先能找到一个随机数 nonce，满足 H（block header || nonce） <= target。第一个找到随机数的节点就可以创建区块并向其他节点广播，并伴随一些比特币的奖励，这就是对「挖矿」过程的简单描述。

我们知道，找到随机数的过程没有捷径，只能通过大量的计算，所以计算证明的过程叫做工作量证明（PoW-proof of work）。

虽然挖矿很难，但验证很容易（difficult to solve, but easy to verify），随机数找到公布给大家后，大家只需要算一次哈希，看结果是否 <= target 即可。

### 4.比特币中用的哈希函数是什么？

SHA-256 (Secure Hash Algorithm)

## 二、数字签名（digital signature）

### 1.比特币的账户管理

现在我们发起转账都需要通过银行，是中心化管理的。比特币是去中心化的，是如何管理账户的呢？

比特币的账户就是一个公私钥对（public key, private key），公钥（public-key）类似我们的银行账户，私钥（private-key）类似银行密码。

### 2.非对称加密（asymmetric encryption algorithm）

了解数字签名之前，需要先对非对称加密有一定认识。

2.1 什么是非对称加密？

![](res/asymmetric_encryption.png)

Alice 想通过非对称加密的方式发送一条消息给 Bob，他要怎么做呢？

1. Bob 需要先生成公钥私钥对（public key, private key）
2. Bob 的公钥是对所有人公开的，所以 Alice 可以拿到 Bob's public key
3. Alice 使用 Bob's public key 对 Message 加密，并将密文通过网络传输给 Bob
4. Bob 接收到密文后，使用自己的私钥 Bob's private key 解密，得到了 Message
5. 完成通信

由于 Bob's private key 是保存在 Bob 手里的，只要


私钥签名，公钥验证

生成公私钥对的前提，要有好的随机源a good source of randomness